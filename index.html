<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InSAR å¹´ä¼šç«é€ŸæŠ¢ç­”ç³»ç»Ÿ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #06b6d4; --accent: #f43f5e; --text: #f8fafc; --green: #10b981; }
        body { margin: 0; font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; touch-action: manipulation; }
        
        /* é€šç”¨ç±» */
        .hidden { display: none !important; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 1rem; }
        .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 0 15px rgba(6, 182, 212, 0.4); }
        .btn-primary:active { transform: scale(0.95); }
        
        /* === è§†å›¾: æ€»æ§å° === */
        #view-dashboard { padding: 40px; text-align: center; overflow-y: auto; height: 100vh; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; max-width: 1000px; margin: 0 auto; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid #334155; cursor: pointer; }
        .card:hover { border-color: var(--primary); background: #263344; }

        /* === è§†å›¾: å¤§å±ç«¯ === */
        #view-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; position: relative; padding-top: 40px; }
        .q-title { font-size: 2.5rem; font-weight: bold; text-align: center; margin-bottom: 20px; max-width: 90%; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* é€‰é¡¹æ˜¾ç¤º (å¤§å±) */
        .screen-opts { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 80%; margin-top: 20px; }
        .s-opt { background: rgba(255,255,255,0.05); padding: 20px; font-size: 1.5rem; border-radius: 10px; border: 2px solid transparent; }
        .s-opt.correct { background: var(--green); color: black; border-color: #fff; box-shadow: 0 0 30px var(--green); animation: pulse 1s infinite; }

        /* äºŒç»´ç é®ç½© */
        .qr-layer { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .timer-big { font-size: 8rem; font-weight: 900; color: var(--primary); font-family: monospace; text-shadow: 0 0 40px var(--primary); }
        .join-count { font-size: 1.5rem; margin-top: 20px; color: #94a3b8; }
        
        /* æ’è¡Œæ¦œ */
        .rank-board { position: absolute; right: 20px; top: 100px; width: 300px; background: rgba(0,0,0,0.5); border-radius: 15px; padding: 15px; border: 1px solid #334155; }
        .rank-title { text-align: center; color: var(--accent); font-weight: bold; margin-bottom: 10px; font-size: 1.2rem; }
        .rank-list { list-style: none; padding: 0; margin: 0; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem; }
        .rank-item:first-child { color: #ffd700; font-weight: bold; font-size: 1.3rem; } /* é‡‘ç‰Œ */
        .rank-item:nth-child(2) { color: #c0c0c0; } /* é“¶ç‰Œ */
        .rank-item:nth-child(3) { color: #cd7f32; } /* é“œç‰Œ */

        /* === è§†å›¾: æ‰‹æœºç«¯ === */
        #view-mobile { padding: 20px; min-height: 100vh; background: #0f172a; display: flex; flex-direction: column; }
        .input-group { margin-bottom: 30px; text-align: center; }
        .name-input { width: 80%; padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none; text-align: center; outline: none; margin-bottom: 15px; }
        .m-opts { display: flex; flex-direction: column; gap: 15px; }
        .m-btn { padding: 18px; background: #334155; border: 2px solid #475569; color: white; border-radius: 12px; font-size: 1.1rem; text-align: left; }
        .m-btn.selected { background: var(--primary); border-color: white; color: black; }
        .m-status { text-align: center; margin-top: 30px; font-size: 1.2rem; font-weight: bold; color: var(--green); }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="view-dashboard" class="hidden">
        <h1 style="color: var(--primary);">ğŸ›°ï¸ InSAR ç«é€ŸæŠ¢ç­”æ€»æ§</h1>
        <div style="margin-bottom: 20px; font-size: 0.9rem; color: #64748b;">
            æœ¬ç³»ç»Ÿä½¿ç”¨å…¬å…±MQTTæœåŠ¡é€šä¿¡ï¼Œè¯·ç¡®ä¿ç½‘ç»œé€šç•…<br>
            æˆ¿é—´å·: <span id="room-id-disp" style="color:white; font-weight:bold;"></span>
        </div>
        <div class="grid" id="dash-grid"></div>
    </div>

    <div id="view-screen" class="hidden">
        <div style="position: absolute; top:10px; left:10px; opacity:0.3;">
            <button onclick="goHome()">ğŸ </button>
        </div>

        <div class="q-title" id="s-text">é¢˜ç›®åŠ è½½ä¸­...</div>

        <div class="rank-board">
            <div class="rank-title">ğŸ† å®æ—¶æé€Ÿæ¦œ</div>
            <ul class="rank-list" id="rank-list">
                <li style="text-align:center; color:#666; font-size:0.9rem;">æš‚æ— ç­”é¢˜æ•°æ®</li>
            </ul>
        </div>

        <div class="screen-opts hidden" id="s-opts-area"></div>

        <div id="qr-layer" class="qr-layer hidden">
            <h2 style="color:white; margin-bottom:10px;">è¾“å…¥åå­— Â· æé€ŸæŠ¢ç­”</h2>
            <div style="background:white; padding:15px; border-radius:10px;">
                <div id="qrcode"></div>
            </div>
            <div class="timer-big" id="timer">120</div>
            <div class="join-count">å·²æ”¶åˆ° <span id="ans-count" style="color:var(--primary); font-weight:bold;">0</span> ä»½ç­”æ¡ˆ</div>
            <div style="margin-top:20px; color:#64748b;">æŒ‰ [ç©ºæ ¼] ç»“æŸå¹¶çœ‹ç­”æ¡ˆ</div>
        </div>

        <div style="position:absolute; bottom:20px; color:#475569;">[ç©ºæ ¼] æ§åˆ¶æµç¨‹</div>
    </div>

    <div id="view-mobile" class="hidden">
        <div id="m-login">
            <h2 style="text-align:center; margin-top:50px;">ğŸ‘‹ æ¬¢è¿å‚åŠ æŠ¢ç­”</h2>
            <div class="input-group">
                <input type="text" id="username" class="name-input" placeholder="è¯·è¾“å…¥ä½ çš„åå­—/æ˜µç§°" maxlength="8">
                <button class="btn btn-primary" onclick="mobileLogin()" style="width:85%">è¿›å…¥è€ƒåœº</button>
            </div>
        </div>

        <div id="m-quiz" class="hidden">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; color:#94a3b8;">
                <span id="m-user-disp"></span>
                <span id="m-q-idx">Q1</span>
            </div>
            <div id="m-q-text" style="font-size:1.1rem; margin-bottom:30px; line-height:1.4;"></div>
            <div class="m-opts" id="m-opts-area"></div>
            <div id="m-status" class="m-status hidden"></div>
        </div>
    </div>

<script>
    // ================= é…ç½®ä¸æ•°æ® =================
    // ä¸ºäº†é¿å…ä¸²å°ï¼Œç”Ÿæˆä¸€ä¸ªéšæœºçš„æˆ¿é—´IDï¼ˆåŸºäºæ—¶é—´æˆ³ï¼‰
    let ROOM_ID = localStorage.getItem('insar_room_id');
    if(!ROOM_ID) {
        ROOM_ID = 'insar_' + Math.floor(Math.random() * 10000);
        localStorage.setItem('insar_room_id', ROOM_ID);
    }
    
    // MQTT å…¬å…±æœåŠ¡å™¨ (å…è´¹ã€å…é…ç½®)
    const MQTT_BROKER = 'wss://broker.emqx.io:8084/mqtt';
    const TOPIC_SUBMIT = `quiz/${ROOM_ID}/submit`; // æ‰‹æœºæäº¤ç­”æ¡ˆ
    const TOPIC_STATE  = `quiz/${ROOM_ID}/state`;  // å¤§å±å¹¿æ’­çŠ¶æ€

    const questions = [
        { q: "åœ¨ SNAP è½¯ä»¶å¤„ç†å¹²æ¶‰æ—¶ï¼Œç¬¬ä¸€æ­¥é€šå¸¸æ˜¯å¯¹ä¸¤æ™¯å½±åƒè¿›è¡Œä»€ä¹ˆæ“ä½œï¼Ÿ", a: ["ç›¸ä½è§£ç¼ ", "é…å‡† (Coregistration)", "å»å¹³åœ°æ•ˆåº”", "åœ°ç†ç¼–ç "], c: 1 },
        { q: "Goldstein æ»¤æ³¢ç®—æ³•ä¸»è¦æ˜¯åœ¨å“ªä¸ªåŸŸè¿›è¡Œæ“ä½œçš„ï¼Ÿ", a: ["æ—¶åŸŸ", "é¢‘åŸŸ (Frequency Domain)", "ç©ºé—´åŸŸ", "è‰²å½©åŸŸ"], c: 1 },
        { q: "GAMMA æˆ– SARscape ä¸­è¿›è¡Œç›¸ä½è§£ç¼ ï¼Œæœ€ç»å…¸çš„ç®—æ³•æ˜¯ï¼Ÿ", a: ["MCF (æœ€å°è´¹ç”¨æµ)", "KNN (K-è¿‘é‚»)", "SVM (æ”¯æŒå‘é‡æœº)", "RGBè‰²å½©å¹³è¡¡"], c: 0 },
        { q: "D-InSAR æµç¨‹ä¸­å¯¼å…¥å¤–éƒ¨ DEM çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼Ÿ", a: ["æ¨¡æ‹Ÿå¹¶å»é™¤åœ°å½¢ç›¸ä½", "è®¡ç®—è½¨é“é«˜åº¦", "ç¾åŒ–ç»“æœ", "å»é™¤å¤§æ°”è¯¯å·®"], c: 0 },
        { q: "Sentinel-1 ç‹¬ç‰¹çš„ TOPS æ¨¡å¼å¿…é¡»è¿›è¡Œå“ªé¡¹é¢„å¤„ç†ï¼Ÿ", a: ["Deburst (å»çªå‘)", "De-noise", "Sharpen", "Crop"], c: 0 },
        { q: "ç»“åˆå‡é™è½¨è§£ç®—ä¸‰ç»´å½¢å˜ï¼Œä¸»è¦åˆ©ç”¨äº†å‡é™è½¨çš„ä»€ä¹ˆå·®å¼‚ï¼Ÿ", a: ["æ³¢é•¿ä¸åŒ", "é£è¡Œæ–¹å‘/å…¥å°„è§’å‡ ä½•å·®å¼‚", "å«æ˜Ÿå“ç‰Œ", "æ—¶é—´ä¸åŒ"], c: 1 },
        { q: "å½¢å˜è¿‡å¤§å¯¼è‡´æ¡çº¹è¿‡å¯†æ— æ³•è§£ç¼ æ—¶ï¼Œåº”æ”¹ç”¨ä»€ä¹ˆæŠ€æœ¯ï¼Ÿ", a: ["Offset-tracking (åç§»é‡è¿½è¸ª)", "PS-InSAR", "SBAS-InSAR", "æåŒ–åˆ†è§£"], c: 0 },
        { q: "SBAS å»é™¤å¤§æ°”ç›¸ä½ï¼Œåˆ©ç”¨äº†å¤§æ°”åœ¨æ—¶ç©ºä¸Šçš„ä»€ä¹ˆç‰¹æ€§ï¼Ÿ", a: ["ç©ºé—´é«˜é¢‘ï¼Œæ—¶é—´ä½é¢‘", "ç©ºé—´ä½é¢‘ï¼Œæ—¶é—´é«˜é¢‘", "éšæœºå™ªå£°", "å¸¸æ•°"], c: 1 },
        { q: "SBAS-InSAR æ„å»ºâ€œå°åŸºçº¿é›†â€æ˜¯ä¸ºäº†æŠ‘åˆ¶å“ªä¸¤ç§å¤±ç›¸å¹²ï¼Ÿ", a: ["å¤§æ°”/ç”µç¦»å±‚", "ç©ºé—´/æ—¶é—´å¤±ç›¸å¹²", "åœ°å½¢/å¹³åœ°", "çƒ­å™ªå£°"], c: 1 },
        { q: "Stacking-InSAR å‡è®¾å¤§æ°”ç›¸ä½è¯¯å·®åœ¨æ—¶é—´åŸŸä¸Šç¬¦åˆä»€ä¹ˆç‰¹å¾ï¼Ÿ", a: ["çº¿æ€§å¢é•¿", "éšæœºä¸”å‡å€¼ä¸ºé›¶", "å‘¨æœŸå˜åŒ–", "ä¸åœ°å½¢ç›¸å…³"], c: 1 }
    ];

    // å…¨å±€å˜é‡
    let mqttClient;
    let currentMode = 'dashboard';
    let currentQId = 0;
    let startTime = 0; // å¤§å±å¼€å§‹è®¡æ—¶çš„æ—¶åˆ»
    let answersMap = {}; // å­˜å‚¨å½“å‰é¢˜ç›®çš„æ‰€æœ‰ç­”æ¡ˆ {name: {ans:0, time:123}}

    // ================= åˆå§‹åŒ– =================
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const qId = parseInt(urlParams.get('q')) || 0;
    const baseUrl = window.location.origin + window.location.pathname;

    window.onload = () => {
        initMQTT();
        if (mode === 'mobile') initMobile();
        else if (mode === 'screen') initScreen();
        else initDashboard();
    };

    // å»ºç«‹ MQTT è¿æ¥
    function initMQTT() {
        mqttClient = mqtt.connect(MQTT_BROKER);
        
        mqttClient.on('connect', () => {
            console.log('MQTT Connected via ' + ROOM_ID);
            // æ‰€æœ‰äººè®¢é˜…å¤§å±çŠ¶æ€
            mqttClient.subscribe(TOPIC_STATE);
            
            // å¦‚æœæ˜¯å¤§å±ï¼Œè®¢é˜…æäº¤é¢‘é“
            if (mode === 'screen') {
                mqttClient.subscribe(TOPIC_SUBMIT);
            }
        });

        mqttClient.on('message', (topic, message) => {
            const msg = JSON.parse(message.toString());
            
            if (topic === TOPIC_SUBMIT && mode === 'screen') {
                handleSubmission(msg);
            }
        });
    }

    // ================= è§†å›¾ 1: æ€»æ§å° =================
    function initDashboard() {
        document.getElementById('view-dashboard').classList.remove('hidden');
        document.getElementById('room-id-disp').innerText = ROOM_ID;
        const grid = document.getElementById('dash-grid');
        
        questions.forEach((q, idx) => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3 style="color:var(--primary); margin-top:0;">ç¬¬ ${idx+1} é¢˜</h3>
                <div style="font-size:0.8rem; height:40px; overflow:hidden;">${q.q}</div>
                <div style="margin-top:10px; color:#94a3b8; font-size:0.8rem;">ç‚¹å‡»å¼€å¯</div>
            `;
            card.onclick = () => window.location.href = `${baseUrl}?mode=screen&q=${idx}`;
            grid.appendChild(card);
        });
    }

    // ================= è§†å›¾ 2: å¤§å±ç«¯ =================
    let screenState = 0; // 0=è¯»é¢˜, 1=æŠ¢ç­”ä¸­, 2=å…¬å¸ƒ
    let timerInt;

    function initScreen() {
        document.getElementById('view-screen').classList.remove('hidden');
        currentQId = qId;
        const q = questions[qId];

        // æ¸²æŸ“é¢˜ç›®
        document.getElementById('s-text').innerText = q.q;
        
        // æ¸²æŸ“é€‰é¡¹ï¼ˆåˆå§‹éšè—ï¼‰
        const optArea = document.getElementById('s-opts-area');
        const chars = ['A', 'B', 'C', 'D'];
        q.a.forEach((opt, i) => {
            const d = document.createElement('div');
            d.className = 's-opt';
            d.id = `s-opt-${i}`;
            d.innerText = `${chars[i]}. ${opt}`;
            optArea.appendChild(d);
        });

        // ç›‘å¬ç©ºæ ¼
        document.addEventListener('keydown', (e) => {
            if(e.code === 'Space') nextScreenStep();
        });
    }

    function nextScreenStep() {
        const qrLayer = document.getElementById('qr-layer');
        const optArea = document.getElementById('s-opts-area');

        if (screenState === 0) {
            // ---> è¿›å…¥æŠ¢ç­”é˜¶æ®µ
            screenState = 1;
            answersMap = {}; // æ¸…ç©ºä¸Šä¸€é¢˜æ•°æ®
            updateRankBoard(); // æ¸…ç©ºæ¦œå•
            document.getElementById('ans-count').innerText = "0";
            
            qrLayer.classList.remove('hidden');
            optArea.classList.add('hidden');
            
            // ç”ŸæˆäºŒç»´ç 
            const mobileUrl = `${baseUrl}?mode=mobile&q=${currentQId}&room=${ROOM_ID}`;
            document.getElementById('qrcode').innerHTML = "";
            new QRCode(document.getElementById('qrcode'), {
                text: mobileUrl, width: 250, height: 250
            });

            // å¼€å§‹å€’è®¡æ—¶
            let t = 120;
            startTime = Date.now(); // è®°å½•å¼€å§‹æ—¶é—´ç”¨äºè®¡ç®—æ’å
            document.getElementById('timer').innerText = t;
            
            // å¹¿æ’­å¼€å§‹ä¿¡å·ç»™æ‰‹æœº (é˜²æ­¢æå‰æŠ¢ç­”)
            /* ç®€å•èµ·è§ï¼Œè¿™é‡Œä¸å¼ºåˆ¶é”æ‰‹æœºï¼Œæ‰‹æœºç«¯æ ¹æ®è¿›å…¥æ—¶é—´åˆ¤æ–­ */
            
            timerInt = setInterval(() => {
                t--;
                document.getElementById('timer').innerText = t;
                if(t<=0) nextScreenStep();
            }, 1000);

        } else if (screenState === 1) {
            // ---> å…¬å¸ƒç­”æ¡ˆ
            screenState = 2;
            clearInterval(timerInt);
            qrLayer.classList.add('hidden');
            optArea.classList.remove('hidden');

            // é«˜äº®æ­£ç¡®ç­”æ¡ˆ
            const correctIdx = questions[currentQId].c;
            document.getElementById(`s-opt-${correctIdx}`).classList.add('correct');

        } else if (screenState === 2) {
            // ---> ä¸‹ä¸€é¢˜
            if (currentQId < questions.length - 1) {
                window.location.href = `${baseUrl}?mode=screen&q=${currentQId + 1}`;
            } else {
                alert("æ¯”èµ›ç»“æŸï¼");
                goHome();
            }
        }
    }

    // å¤„ç†æ”¶åˆ°çš„ç­”æ¡ˆ
    function handleSubmission(data) {
        // data = { name: "å¼ ä¸‰", ans: 1, q: 0 }
        if (data.q !== currentQId) return; // é¢˜ç›®ä¸åŒ¹é…
        if (screenState !== 1) return; // ä¸åœ¨æŠ¢ç­”æ—¶é—´

        // å¦‚æœè¿™ä¸ªäººæ²¡ç­”è¿‡ï¼Œè®°å½•ä¸‹æ¥
        if (!answersMap[data.name]) {
            const timeUsed = (Date.now() - startTime) / 1000; // ç”¨æ—¶ç§’
            answersMap[data.name] = {
                ans: data.ans,
                time: timeUsed.toFixed(2)
            };
            
            // æ›´æ–°UIè®¡æ•°
            document.getElementById('ans-count').innerText = Object.keys(answersMap).length;
            
            // å®æ—¶åˆ·æ–°æ’è¡Œæ¦œ
            updateRankBoard();
        }
    }

    function updateRankBoard() {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        
        const correctIdx = questions[currentQId].c;
        
        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
        // è§„åˆ™ï¼šç­”å¯¹ä¼˜å…ˆï¼Œç„¶åæŒ‰æ—¶é—´æ’åº
        const sorted = Object.entries(answersMap)
            .filter(([name, val]) => val.ans === correctIdx) // åªæ˜¾ç¤ºç­”å¯¹çš„
            .sort((a, b) => a[1].time - b[1].time) // æ—¶é—´è¶ŠçŸ­è¶Šå‰
            .slice(0, 5); // å–å‰5å

        if (sorted.length === 0) {
            list.innerHTML = '<li style="text-align:center;color:#666">è™šä½ä»¥å¾…...</li>';
            return;
        }

        sorted.forEach(([name, val], idx) => {
            const li = document.createElement('li');
            li.className = 'rank-item animate__animated animate__fadeInRight';
            li.innerHTML = `
                <span>${idx+1}. ${name}</span>
                <span>${val.time}s</span>
            `;
            list.appendChild(li);
        });
    }

    // ================= è§†å›¾ 3: æ‰‹æœºç«¯ =================
    function initMobile() {
        document.getElementById('view-mobile').classList.remove('hidden');
        // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„ç”¨æˆ·å
        const savedName = localStorage.getItem('insar_username');
        if (savedName) {
            document.getElementById('username').value = savedName;
        }
        
        // è§£æ URL ä¸­çš„æˆ¿é—´å·ï¼Œç¡®ä¿å¯¹ä¸Šå·
        const urlRoom = new URLSearchParams(window.location.search).get('room');
        if (urlRoom && urlRoom !== ROOM_ID) {
            ROOM_ID = urlRoom; // æ›´æ–°æ‰‹æœºç«¯çš„æˆ¿é—´å·
            initMQTT(); // é‡æ–°è¿æ¥æ­£ç¡®çš„é¢‘é“
        }
    }

    function mobileLogin() {
        const name = document.getElementById('username').value.trim();
        if(!name) return alert("è¯·å…ˆè¾“å…¥å¤§åï¼");
        
        localStorage.setItem('insar_username', name);
        document.getElementById('m-login').classList.add('hidden');
        document.getElementById('m-quiz').classList.remove('hidden');
        
        renderMobileQuestion(name);
    }

    function renderMobileQuestion(name) {
        document.getElementById('m-user-disp').innerText = `ğŸ‘¤ ${name}`;
        const q = questions[qId];
        document.getElementById('m-q-text').innerText = q.q;

        const optArea = document.getElementById('m-opts-area');
        
        // === å…³é”®ï¼šé€‰é¡¹ä¹±åºé€»è¾‘ ===
        // åˆ›å»ºä¸€ä¸ªåŒ…å« {text, originalIndex} çš„æ•°ç»„
        let optsObj = q.a.map((txt, idx) => ({ text: txt, idx: idx }));
        
        // Fisher-Yates æ´—ç‰Œç®—æ³•
        for (let i = optsObj.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [optsObj[i], optsObj[j]] = [optsObj[j], optsObj[i]];
        }

        // æ¸²æŸ“ä¹±åºåçš„æŒ‰é’®
        optsObj.forEach(obj => {
            const btn = document.createElement('button');
            btn.className = 'm-btn';
            // æ‰‹æœºç«¯ä¸æ˜¾ç¤º ABCDï¼Œåªæ˜¾ç¤ºå†…å®¹ï¼Œé˜²æ­¢æŠ¥ç­”æ¡ˆ
            // æˆ–è€…æ˜¾ç¤ºå†…å®¹
            btn.innerText = obj.text;
            btn.onclick = () => submitMobileAnswer(obj.idx, btn);
            optArea.appendChild(btn);
        });
    }

    function submitMobileAnswer(originalIdx, btn) {
        const name = localStorage.getItem('insar_username');
        
        // å‘é€ MQTT æ¶ˆæ¯
        const payload = JSON.stringify({
            name: name,
            ans: originalIdx,
            q: qId
        });
        
        mqttClient.publish(TOPIC_SUBMIT, payload);
        
        // UI åé¦ˆ
        const allBtns = document.querySelectorAll('.m-btn');
        allBtns.forEach(b => {
            b.disabled = true;
            b.style.opacity = 0.6;
        });
        btn.classList.add('selected');
        btn.style.opacity = 1;
        
        const status = document.getElementById('m-status');
        status.innerText = "ğŸš€ ç­”æ¡ˆå·²é£å‘å¤§å±ï¼";
        status.classList.remove('hidden');
    }

    function goHome() {
        window.location.href = baseUrl;
    }
</script>
</body>
</html>
