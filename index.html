<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InSAR æŠ¢ç­” (æ ¸å¼¹æ•‘æ€¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --bg: #0f172a; --primary: #f59e0b; --text: #fff; --green: #10b981; }
        body { margin: 0; font-family: 'Microsoft YaHei', sans-serif; background: var(--bg); color: var(--text); overflow: hidden; }
        
        .hidden { display: none !important; }
        .btn { padding: 15px; width: 100%; border-radius: 8px; border: none; font-weight: bold; font-size: 1.1rem; background: var(--primary); color: #000; margin-top: 10px; }

        /* é¡¶éƒ¨çŠ¶æ€ */
        .status-bar { position: fixed; top: 0; width: 100%; background: #000; color: #aaa; font-size: 12px; padding: 5px; text-align: center; z-index: 999; }
        .ok { color: #10b981; font-weight: bold; }

        /* åº•éƒ¨è°ƒè¯•æµ (æ ¸å¿ƒåŠŸèƒ½) */
        .data-stream { position: fixed; bottom: 0; width: 100%; height: 40px; background: rgba(255,0,0,0.2); border-top: 1px solid red; font-family: monospace; font-size: 12px; line-height: 40px; padding: 0 20px; white-space: nowrap; overflow: hidden; pointer-events: none; z-index: 999; color: #ff9999; }

        /* è§†å›¾å¸ƒå±€ */
        #view-screen { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .q-text { font-size: 2.5rem; font-weight: bold; margin: 20px; text-align: center; max-width: 90%; }
        
        /* é€‰é¡¹ */
        .opts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 80%; margin-top: 20px; }
        .opt { background: rgba(255,255,255,0.1); padding: 20px; font-size: 1.5rem; border-radius: 10px; border: 2px solid transparent; }
        .opt.correct { background: var(--green); color: #000; font-weight: bold; }

        /* äºŒç»´ç å±‚ */
        .qr-layer { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* æ¦œå• */
        .rank-box { position: fixed; right: 20px; top: 50px; width: 250px; background: rgba(0,0,0,0.8); border: 1px solid #444; border-radius: 10px; padding: 10px; }
        .rank-item { padding: 5px 0; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }

        /* æ‰‹æœºç«¯ */
        #view-mobile { padding: 20px; min-height: 100vh; }
        .m-input { width: 100%; padding: 15px; font-size: 1.2rem; text-align: center; margin-bottom: 20px; box-sizing: border-box; }
        .m-opt { background: #334155; color: white; padding: 20px; margin-bottom: 10px; border-radius: 8px; text-align: left; }
    </style>
</head>
<body>

    <div class="status-bar">
        æœåŠ¡å™¨: HiveMQ | çŠ¶æ€: <span id="st">è¿æ¥ä¸­...</span> | æˆ¿é—´: <span id="rid">8888</span>
    </div>

    <div class="data-stream" id="debug-line">ç­‰å¾…æ•°æ®æµ... (åªè¦æ‰‹æœºæäº¤ï¼Œè¿™é‡Œå¿…é¡»ä¼šè·³åŠ¨)</div>

    <div id="view-dash" class="hidden" style="padding: 50px; text-align: center;">
        <h1>ğŸ”¥ æ•‘æ€¥ç‰ˆæ€»æ§</h1>
        <button class="btn" onclick="startScreen()" style="max-width:300px;">å¼€å¯å¤§å±</button>
    </div>

    <div id="view-screen" class="hidden">
        <div class="q-text" id="s-text">é¢˜ç›®åŠ è½½ä¸­...</div>
        
        <div class="opts-grid hidden" id="s-opts"></div>

        <div class="rank-box">
            <div style="color:var(--primary); font-weight:bold; text-align:center;">å®æ—¶æ¦œå•</div>
            <div id="rank-list"></div>
        </div>

        <div id="qr-layer" class="qr-layer hidden">
            <h2 style="color:white;">æ‰‹æœºæ‰«ç  -> è¿›æˆ¿é—´ 8888</h2>
            <div style="background:white; padding:15px; border-radius:10px;">
                <div id="qrcode"></div>
            </div>
            <h1 style="font-size: 5rem; color:var(--primary); margin: 10px 0;" id="timer">120</h1>
            <div style="color:#ccc;">æ”¶åˆ° <span id="cnt" style="color:white; font-weight:bold;">0</span> ä»½ç­”æ¡ˆ</div>
            <div style="margin-top:20px;">æŒ‰ [ç©ºæ ¼] ç»“æŸ</div>
        </div>
    </div>

    <div id="view-mobile" class="hidden">
        <div id="m-login" style="margin-top:50px; text-align:center;">
            <h2>è¾“å…¥åå­—</h2>
            <input type="text" id="username" class="m-input" placeholder="ä¾‹å¦‚: ç‹å·¥">
            <button class="btn" onclick="mLogin()">è¿›å…¥</button>
        </div>

        <div id="m-quiz" class="hidden">
            <div style="display:flex; justify-content:space-between; color:#888;">
                <span id="m-name"></span>
                <span>Q1</span>
            </div>
            <p id="m-text" style="font-size:1.1rem; margin:20px 0;"></p>
            <div id="m-opts"></div>
            <div id="m-msg" style="text-align:center; margin-top:20px; color:var(--green); font-weight:bold;"></div>
        </div>
    </div>

<script>
    // === ğŸš¨ å¼ºåˆ¶å†™æ­»é…ç½® ğŸš¨ ===
    const ROOM_ID = '8888'; // æˆ¿é—´å·å†™æ­»ï¼Œç»å¯¹ä¸ä¹±å˜
    const BROKER = 'wss://broker.hivemq.com:8000/mqtt'; // æ¢ä¸€ä¸ªæ›´ç¨³çš„æœåŠ¡å™¨
    const TOPIC = `insar/${ROOM_ID}/data`;

    // é¢˜ç›®æ•°æ®
    const questions = [
        { q: "æµ‹è¯•é¢˜ï¼šç‚¹å‡»ä»»æ„é€‰é¡¹ï¼Œçœ‹å¤§å±åº•éƒ¨æ˜¯å¦æœ‰çº¢å­—è·³åŠ¨ï¼Ÿ", a: ["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C", "é€‰é¡¹D"], c: 0 },
        { q: "åœ¨ SNAP è½¯ä»¶å¤„ç†å¹²æ¶‰æ—¶ï¼Œç¬¬ä¸€æ­¥é€šå¸¸æ˜¯å¯¹ä¸¤æ™¯å½±åƒè¿›è¡Œä»€ä¹ˆæ“ä½œï¼Ÿ", a: ["ç›¸ä½è§£ç¼ ", "é…å‡† (Coregistration)", "å»å¹³åœ°æ•ˆåº”", "åœ°ç†ç¼–ç "], c: 1 },
        { q: "Goldstein æ»¤æ³¢ç®—æ³•ä¸»è¦æ˜¯åœ¨å“ªä¸ªåŸŸè¿›è¡Œæ“ä½œçš„ï¼Ÿ", a: ["æ—¶åŸŸ", "é¢‘åŸŸ (Frequency Domain)", "ç©ºé—´åŸŸ", "è‰²å½©åŸŸ"], c: 1 },
        { q: "GAMMA æˆ– SARscape ä¸­è¿›è¡Œç›¸ä½è§£ç¼ ï¼Œæœ€ç»å…¸çš„ç®—æ³•æ˜¯ï¼Ÿ", a: ["MCF (æœ€å°è´¹ç”¨æµ)", "KNN (K-è¿‘é‚»)", "SVM (æ”¯æŒå‘é‡æœº)", "RGBè‰²å½©å¹³è¡¡"], c: 0 },
        { q: "D-InSAR æµç¨‹ä¸­å¯¼å…¥å¤–éƒ¨ DEM çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼Ÿ", a: ["æ¨¡æ‹Ÿå¹¶å»é™¤åœ°å½¢ç›¸ä½", "è®¡ç®—è½¨é“é«˜åº¦", "ç¾åŒ–ç»“æœ", "å»é™¤å¤§æ°”è¯¯å·®"], c: 0 },
        { q: "Sentinel-1 ç‹¬ç‰¹çš„ TOPS æ¨¡å¼å¿…é¡»è¿›è¡Œå“ªé¡¹é¢„å¤„ç†ï¼Ÿ", a: ["Deburst (å»çªå‘)", "De-noise", "Sharpen", "Crop"], c: 0 },
        { q: "ç»“åˆå‡é™è½¨è§£ç®—ä¸‰ç»´å½¢å˜ï¼Œä¸»è¦åˆ©ç”¨äº†å‡é™è½¨çš„ä»€ä¹ˆå·®å¼‚ï¼Ÿ", a: ["æ³¢é•¿ä¸åŒ", "é£è¡Œæ–¹å‘/å…¥å°„è§’å‡ ä½•å·®å¼‚", "å«æ˜Ÿå“ç‰Œ", "æ—¶é—´ä¸åŒ"], c: 1 },
        { q: "å½¢å˜è¿‡å¤§å¯¼è‡´æ¡çº¹è¿‡å¯†æ— æ³•è§£ç¼ æ—¶ï¼Œåº”æ”¹ç”¨ä»€ä¹ˆæŠ€æœ¯ï¼Ÿ", a: ["Offset-tracking (åç§»é‡è¿½è¸ª)", "PS-InSAR", "SBAS-InSAR", "æåŒ–åˆ†è§£"], c: 0 },
        { q: "SBAS å»é™¤å¤§æ°”ç›¸ä½ï¼Œåˆ©ç”¨äº†å¤§æ°”åœ¨æ—¶ç©ºä¸Šçš„ä»€ä¹ˆç‰¹æ€§ï¼Ÿ", a: ["ç©ºé—´é«˜é¢‘ï¼Œæ—¶é—´ä½é¢‘", "ç©ºé—´ä½é¢‘ï¼Œæ—¶é—´é«˜é¢‘", "éšæœºå™ªå£°", "å¸¸æ•°"], c: 1 },
        { q: "SBAS-InSAR æ„å»ºâ€œå°åŸºçº¿é›†â€æ˜¯ä¸ºäº†æŠ‘åˆ¶å“ªä¸¤ç§å¤±ç›¸å¹²ï¼Ÿ", a: ["å¤§æ°”/ç”µç¦»å±‚", "ç©ºé—´/æ—¶é—´å¤±ç›¸å¹²", "åœ°å½¢/å¹³åœ°", "çƒ­å™ªå£°"], c: 1 },
        { q: "Stacking-InSAR å‡è®¾å¤§æ°”ç›¸ä½è¯¯å·®åœ¨æ—¶é—´åŸŸä¸Šç¬¦åˆä»€ä¹ˆç‰¹å¾ï¼Ÿ", a: ["çº¿æ€§å¢é•¿", "éšæœºä¸”å‡å€¼ä¸ºé›¶", "å‘¨æœŸå˜åŒ–", "ä¸åœ°å½¢ç›¸å…³"], c: 1 }
    ];

    let client;
    let currQ = 0;
    let answers = [];
    let startTime = Date.now();
    let screenState = 0; // 0=QR, 1=Result

    const params = new URLSearchParams(window.location.search);
    const mode = params.get('mode') || 'dash';
    // å¦‚æœURLå¸¦äº†qå‚æ•°ï¼Œç”¨URLçš„
    const qParam = parseInt(params.get('q'));
    if (!isNaN(qParam)) currQ = qParam;

    window.onload = () => {
        initMQTT();
        if (mode === 'mobile') initMobile();
        else if (mode === 'screen') initScreen();
        else document.getElementById('view-dash').classList.remove('hidden');
    };

    function initMQTT() {
        client = mqtt.connect(BROKER);
        
        client.on('connect', () => {
            document.getElementById('st').innerText = "å·²è¿æ¥ (ğŸŸ¢)";
            document.getElementById('st').className = "ok";
            // æ— è®ºæ˜¯å¤§å±è¿˜æ˜¯æ‰‹æœºï¼Œéƒ½è®¢é˜…ï¼Œç¡®ä¿åŒå‘é€š
            client.subscribe(TOPIC);
        });

        client.on('error', (e) => {
            document.getElementById('st').innerText = "è¿æ¥å¤±è´¥ (ğŸ”´)";
            document.getElementById('debug-line').innerText = "MQTT Error: " + e;
        });

        client.on('message', (topic, msg) => {
            // === æ ¸å¿ƒç›‘æ§ ===
            // åªè¦æ”¶åˆ°æ¶ˆæ¯ï¼Œåº•éƒ¨çº¢å­—å¿…é¡»é—ªåŠ¨
            const raw = msg.toString();
            const ts = new Date().toLocaleTimeString();
            document.getElementById('debug-line').innerText = `[${ts}] æ”¶åˆ°æ•°æ®: ${raw}`;
            
            if (mode === 'screen') {
                try {
                    const data = JSON.parse(raw);
                    handleData(data);
                } catch(e) {}
            }
        });
    }

    // === æ€»æ§ ===
    function startScreen() {
        window.location.href = `?mode=screen&q=${currQ}`; // åˆå§‹è¿›Q0
    }

    // === å¤§å± ===
    function initScreen() {
        document.getElementById('view-screen').classList.remove('hidden');
        renderQ();

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') nextStep();
        });
    }

    function renderQ() {
        const q = questions[currQ];
        document.getElementById('s-text').innerText = q.q;
        
        const area = document.getElementById('s-opts');
        area.innerHTML = '';
        const labs = ['A','B','C','D'];
        q.a.forEach((t, i) => {
            area.innerHTML += `<div class="opt" id="opt-${i}">${labs[i]}. ${t}</div>`;
        });

        // é»˜è®¤ç›´æ¥æ˜¾ç¤ºäºŒç»´ç 
        showQR();
    }

    function showQR() {
        screenState = 0;
        answers = []; // æ¸…ç©º
        updateRank();
        document.getElementById('cnt').innerText = '0';
        document.getElementById('qr-layer').classList.remove('hidden');
        document.getElementById('s-opts').classList.add('hidden');

        // ç”ŸæˆäºŒç»´ç 
        const url = `${window.location.origin}${window.location.pathname}?mode=mobile&q=${currQ}`;
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById('qrcode'), { text: url, width: 250, height: 250 });

        // å€’è®¡æ—¶
        let t = 120;
        startTime = Date.now();
        window.timerInterval = setInterval(() => { t--; if(t>0) document.getElementById('timer').innerText=t; }, 1000);
    }

    function nextStep() {
        if (screenState === 0) {
            // -> å…¬å¸ƒç­”æ¡ˆ
            screenState = 1;
            clearInterval(window.timerInterval);
            document.getElementById('qr-layer').classList.add('hidden');
            document.getElementById('s-opts').classList.remove('hidden');
            
            // æ˜¾ç¤ºæ­£ç¡®
            const c = questions[currQ].c;
            document.getElementById(`opt-${c}`).classList.add('correct');
            updateRank(true); // æ˜¾ç¤ºå¯¹é”™
        } else {
            // -> ä¸‹ä¸€é¢˜
            if (currQ < questions.length - 1) {
                window.location.href = `?mode=screen&q=${currQ + 1}`;
            } else {
                alert("ç»“æŸï¼");
            }
        }
    }

    function handleData(data) {
        // ğŸš‘ æ•‘æ€¥ç‰ˆé€»è¾‘ï¼šç§»é™¤æ‰€æœ‰çŠ¶æ€åˆ¤æ–­
        // åªè¦é¢˜ç›®IDå¯¹ï¼Œå°±ä¸Šå¢™ï¼Œä¸ç®¡ç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€
        if (data.q != currQ) return; 
        
        // å»é‡
        if (answers.find(a => a.name == data.name)) return;

        answers.push({
            name: data.name,
            ans: data.ans,
            time: ((Date.now() - startTime)/1000).toFixed(2)
        });

        document.getElementById('cnt').innerText = answers.length;
        updateRank(screenState === 1);
    }

    function updateRank(showResult) {
        const list = document.getElementById('rank-list');
        list.innerHTML = "";
        
        // æŒ‰æ—¶é—´æ’åº
        answers.sort((a,b) => a.time - b.time);
        
        answers.slice(0, 10).forEach(a => {
            let st = `${a.time}s`;
            let col = "#fff";
            
            if (showResult) {
                if (a.ans === questions[currQ].c) { st = "âœ… " + st; col = "var(--green)"; }
                else { st = "âŒ"; col = "#f87171"; }
            }
            
            list.innerHTML += `<div class="rank-item" style="color:${col}"><span>${a.name}</span><span>${st}</span></div>`;
        });
    }

    // === æ‰‹æœº ===
    function initMobile() {
        document.getElementById('view-mobile').classList.remove('hidden');
        const saved = localStorage.getItem('user');
        if (saved) document.getElementById('username').value = saved;
    }

    function mLogin() {
        const n = document.getElementById('username').value;
        if(!n) return alert("è¾“å…¥åå­—");
        localStorage.setItem('user', n);
        
        document.getElementById('m-login').classList.add('hidden');
        document.getElementById('m-quiz').classList.remove('hidden');
        renderMQ(n);
    }

    function renderMQ(n) {
        document.getElementById('m-name').innerText = n;
        const q = questions[currQ];
        document.getElementById('m-text').innerText = q.q;
        
        const area = document.getElementById('m-opts');
        q.a.forEach((t, i) => {
            area.innerHTML += `<div class="m-opt" onclick="send(${i}, this)">${t}</div>`;
        });
    }

    function send(i, el) {
        // UI
        Array.from(document.querySelectorAll('.m-opt')).forEach(d=>d.style.opacity=0.5);
        el.style.opacity=1;
        el.style.background='var(--primary)';
        el.style.color='#000';

        // å‘é€
        const pl = JSON.stringify({
            name: localStorage.getItem('user'),
            ans: i,
            q: currQ
        });
        
        if(client && client.connected) {
            client.publish(TOPIC, pl);
            document.getElementById('m-msg').innerText = "âœ… æ•°æ®å·²å‘é€";
        } else {
            alert("æœªè¿æ¥ï¼è¯·åˆ·æ–°");
        }
    }
</script>
</body>
</html>
